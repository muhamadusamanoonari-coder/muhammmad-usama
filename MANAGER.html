<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Money Manager</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .nav-link.active {
            background-color: #4f46e5;
            color: white;
        }
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] { -moz-appearance: textfield; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 0.2s ease-out;
        }
        .modal-leave-active {
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.2s ease-in;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Password Protection Modal -->
    <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-2 text-gray-800">Enter Password</h2>
            <p class="text-gray-500 mb-6">This system is password protected.</p>
            <form id="password-form">
                <input type="password" id="password-input" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-center" placeholder="******">
                <p id="password-error" class="text-red-500 text-sm mt-2 h-4"></p>
                <button type="submit" class="w-full mt-4 bg-indigo-600 text-white py-3 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 font-semibold text-lg">
                    Unlock
                </button>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden modal-enter">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                 <i class="fas fa-exclamation-triangle text-red-600"></i>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-5" id="confirm-modal-title">Delete Item</h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500" id="confirm-modal-text">Are you sure you want to delete this item? This action cannot be undone.</p>
            </div>
            <div class="mt-6 sm:mt-8 sm:flex sm:flex-row-reverse">
                <button id="confirm-modal-delete-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    Delete
                </button>
                <button id="confirm-modal-cancel-btn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Loan Repayment Modal -->
    <div id="repayment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden modal-enter">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="repayment-modal-title">Log a Payment</h3>
            <form id="repayment-form" class="mt-4 space-y-4">
                <input type="hidden" id="repayment-loan-id">
                 <div>
                    <label for="repayment-amount" class="block text-sm font-medium text-gray-700">Payment Amount (Rs)</label>
                    <input type="number" id="repayment-amount" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., 1000">
                </div>
                <div>
                    <label for="repayment-date" class="block text-sm font-medium text-gray-700">Payment Date</label>
                    <input type="date" id="repayment-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                 <div class="mt-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        Save Payment
                    </button>
                    <button id="repayment-modal-cancel-btn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>


    <div id="app-container" class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8 hidden">
        <div id="main-app-content">
            <header class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-wallet text-indigo-600 mr-3"></i> Dur Muhammad Noonari
                    </h1>
                    <p class="text-gray-500 mt-1">A central place to manage your household finances.</p>
                </div>
                <div class="mt-4 sm:mt-0 flex space-x-2">
                    <input type="file" id="import-file-input" class="hidden" accept=".csv">
                    <button id="import-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 font-semibold text-sm flex items-center">
                        <i class="fas fa-file-import mr-2"></i> Import from CSV
                    </button>
                    <button id="export-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 font-semibold text-sm flex items-center">
                        <i class="fas fa-file-export mr-2"></i> Export to CSV (Excel)
                    </button>
                </div>
            </header>

            <nav class="bg-white rounded-lg shadow-sm p-2 flex flex-wrap justify-center sm:flex-nowrap space-x-1 md:space-x-2 mb-6">
                <button id="nav-dashboard" class="nav-link flex-1 py-2 px-3 rounded-md text-xs sm:text-sm font-semibold text-center transition-all"><i class="fas fa-chart-pie mr-2"></i>Dashboard</button>
                <button id="nav-tenants" class="nav-link flex-1 py-2 px-3 rounded-md text-xs sm:text-sm font-semibold text-center transition-all"><i class="fas fa-house-user mr-2"></i>Tenants</button>
                <button id="nav-rent-tracker" class="nav-link flex-1 py-2 px-3 rounded-md text-xs sm:text-sm font-semibold text-center transition-all"><i class="fas fa-calendar-check mr-2"></i>Rent</button>
                <button id="nav-children" class="nav-link flex-1 py-2 px-3 rounded-md text-xs sm:text-sm font-semibold text-center transition-all"><i class="fas fa-child mr-2"></i>Children</button>
                <button id="nav-loans" class="nav-link flex-1 py-2 px-3 rounded-md text-xs sm:text-sm font-semibold text-center transition-all"><i class="fas fa-hand-holding-usd mr-2"></i>Loans</button>
                <button id="nav-transactions" class="nav-link flex-1 py-2 px-3 rounded-md text-xs sm:text-sm font-semibold text-center transition-all"><i class="fas fa-exchange-alt mr-2"></i>Transactions</button>
            </nav>
            
            <main id="main-content">
                <div id="view-dashboard"></div>
                <div id="view-tenants" class="hidden"></div>
                <div id="view-rent-tracker" class="hidden"></div>
                <div id="view-children" class="hidden"></div>
                <div id="view-loans" class="hidden"></div>
                <div id="view-transactions" class="hidden"></div>
            </main>
        </div>
    </div>

    <!-- Local Data Script -->
    <script type="module">
        // --- App Configuration ---
        const APP_PASSWORD = "123";
        
        // --- App State (Single Source of Truth) ---
        let tenants = [];
        let transactions = [];
        let loans = [];
        let children = [];

        const categories = {
            income: ['Salary', 'Rent', 'Business', 'Bank Withdrawal', 'Loan Repayment', 'Other'],
            expense: ['Groceries', 'Utilities', 'Allowance', 'Transportation', 'Medical', 'Loan Payment', 'Other']
        };

        // --- UI Element References ---
        const passwordModal = document.getElementById('password-modal');
        const mainAppContent = document.getElementById('main-app-content');
        const navLinks = document.querySelectorAll('.nav-link');
        const views = {
            dashboard: document.getElementById('view-dashboard'), tenants: document.getElementById('view-tenants'),
            'rent-tracker': document.getElementById('view-rent-tracker'), children: document.getElementById('view-children'),
            loans: document.getElementById('view-loans'), transactions: document.getElementById('view-transactions')
        };
        const confirmModal = document.getElementById('confirm-modal');
        const repaymentModal = document.getElementById('repayment-modal');
        let onConfirmCallback = null;
        
        // --- Initialization ---
        function initializeAppCore() {
            passwordModal.classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            setupUI(); 
            renderAll();
            navigateTo('dashboard');
        }

        function setupPasswordProtection() { 
            document.getElementById('password-form').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const pwd = document.getElementById('password-input').value; 
                if (pwd === APP_PASSWORD) { 
                    sessionStorage.setItem('app_unlocked', 'true'); 
                    initializeAppCore(); 
                } else { 
                    document.getElementById('password-error').textContent = 'Incorrect password.'; 
                } 
            }); 
            if (sessionStorage.getItem('app_unlocked') === 'true') { 
                initializeAppCore(); 
            } 
        }
        
        function setupUI() {
            // Populate views with their HTML content
            views.dashboard.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6"><div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-5 rounded-xl shadow-lg"><h3 class="text-lg font-semibold">Total Income</h3><p id="total-income" class="text-3xl font-bold">Rs 0.00</p></div><div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-5 rounded-xl shadow-lg"><h3 class="text-lg font-semibold">Total Expenses</h3><p id="total-expense" class="text-3xl font-bold">Rs 0.00</p></div><div class="bg-gradient-to-br from-indigo-500 to-indigo-600 text-white p-5 rounded-xl shadow-lg"><h3 class="text-lg font-semibold">Net Balance</h3><p id="net-balance" class="text-3xl font-bold">Rs 0.00</p></div><div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-5 rounded-xl shadow-lg"><h3 class="text-lg font-semibold">Receivables</h3><p id="total-receivables" class="text-3xl font-bold">Rs 0.00</p></div><div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-5 rounded-xl shadow-lg"><h3 class="text-lg font-semibold">Payables</h3><p id="total-payables" class="text-3xl font-bold">Rs 0.00</p></div></div><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">Recent Transactions</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="py-2 px-3">Date</th><th class="py-2 px-3">Description</th><th class="py-2 px-3">Category</th><th class="py-2 px-3 text-right">Amount</th><th class="py-2 px-3 text-center">Actions</th></tr></thead><tbody id="recent-transactions-list"></tbody></table></div></div>`;
            views.tenants.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">Add New Tenant/House</h3><form id="tenant-form" class="space-y-4"><input type="hidden" id="tenant-id"><div><label for="house-name" class="block text-sm font-medium text-gray-700">House / Property Name</label><input type="text" id="house-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., 1st Floor Flat"></div><div><label for="tenant-name" class="block text-sm font-medium text-gray-700">Tenant Full Name</label><input type="text" id="tenant-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., John Doe"></div><div><label for="tenant-contact" class="block text-sm font-medium text-gray-700">Contact Number</label><input type="text" id="tenant-contact" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., 0300-1234567"></div><div><label for="tenant-rent" class="block text-sm font-medium text-gray-700">Monthly Rent (Rs)</label><input type="number" id="tenant-rent" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., 15000"></div><button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-semibold"><i class="fas fa-plus-circle mr-2"></i><span id="tenant-form-btn-text">Add Tenant</span></button></form></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">All Tenants & Houses</h3><div id="tenants-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div></div></div>`;
            views['rent-tracker'].innerHTML = `<div class="bg-white p-6 rounded-xl shadow-md"><div class="flex flex-col sm:flex-row justify-between items-center mb-6"><h3 class="text-2xl font-bold">Rent Payment Tracker</h3><div class="flex items-center space-x-2 mt-4 sm:mt-0"><label for="rent-month" class="text-sm font-medium">Month:</label><select id="rent-month" class="block px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm"></select><label for="rent-year" class="text-sm font-medium">Year:</label><input type="number" id="rent-year" class="block w-24 px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div></div><div id="rent-tracker-list" class="overflow-x-auto"></div></div>`;
            views.children.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1 space-y-6"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">Add New Child</h3><form id="child-form" class="space-y-4"><div><label for="child-name" class="block text-sm font-medium text-gray-700">Child's Name</label><input type="text" id="child-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., Ahmed"></div><button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-semibold"><i class="fas fa-plus-circle mr-2"></i>Add Child</button></form></div><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">Manage Children</h3><div id="children-list" class="space-y-3"></div></div><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">Give Daily Allowance</h3><div id="daily-allowance-giver" class="space-y-4"></div></div></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">Allowance History</h3><div class="overflow-x-auto max-h-[70vh] overflow-y-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="py-2 px-3">Date</th><th class="py-2 px-3">Child's Name</th><th class="py-2 px-3 text-right">Amount</th><th class="py-2 px-3 text-center">Actions</th></tr></thead><tbody id="allowance-history-list"></tbody></table></div></div></div>`;
            views.loans.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">Add New Loan/Credit</h3><form id="loan-form" class="space-y-4"><div><label for="loan-type" class="block text-sm font-medium text-gray-700">Type</label><select id="loan-type" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm"><option value="lent">I Lent Money (Receivable)</option><option value="borrowed">I Borrowed Money (Payable)</option></select></div><div><label for="loan-person" class="block text-sm font-medium text-gray-700">Person's Name</label><input type="text" id="loan-person" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., Ali Khan"></div><div><label for="loan-amount" class="block text-sm font-medium text-gray-700">Total Amount (Rs)</label><input type="number" id="loan-amount" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., 2500"></div><div><label for="loan-date" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="loan-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div><label for="loan-description" class="block text-sm font-medium text-gray-700">Description / Reason</label><input type="text" id="loan-description" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., For bike repair"></div><button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-semibold"><i class="fas fa-save mr-2"></i>Save Loan</button></form></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">Loan Records</h3><div id="loans-list" class="space-y-6 max-h-[60vh] overflow-y-auto pr-2"></div></div></div>`;
            views.transactions.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">Add New Transaction</h3><form id="transaction-form" class="space-y-4"><div><label for="transaction-type" class="block text-sm font-medium text-gray-700">Transaction Type</label><select id="transaction-type" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm"><option value="income">Income</option><option value="expense">Expense</option></select></div><div><label for="transaction-category" class="block text-sm font-medium text-gray-700">Category</label><select id="transaction-category" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm"></select></div><div id="tenant-select-container" class="hidden"><label for="transaction-tenant" class="block text-sm font-medium text-gray-700">Rent From</label><select id="transaction-tenant" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm"></select></div><div><label for="transaction-amount" class="block text-sm font-medium text-gray-700">Amount (Rs)</label><input type="number" id="transaction-amount" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., 5000"></div><div><label for="transaction-date" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="transaction-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div><div><label for="transaction-description" class="block text-sm font-medium text-gray-700">Description</label><input type="text" id="transaction-description" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., Monthly groceries"></div><button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-semibold"><i class="fas fa-check-circle mr-2"></i>Record Transaction</button></form></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">Transaction History</h3><div class="overflow-x-auto max-h-[60vh] overflow-y-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="py-2 px-3">Date</th><th class="py-2 px-3">Description</th><th class="py-2 px-3">Category</th><th class="py-2 px-3 text-right">Amount</th><th class="py-2 px-3 text-center">Actions</th></tr></thead><tbody id="all-transactions-list"></tbody></table></div></div></div>`;
            
            Object.keys(views).forEach(key => document.getElementById(`nav-${key}`)?.addEventListener('click', () => navigateTo(key)));
            
            // Set default dates
            document.getElementById('loan-date').valueAsDate = new Date();
            document.getElementById('transaction-date').valueAsDate = new Date();
            document.getElementById('repayment-date').valueAsDate = new Date();

            const today = new Date();
            const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
            const rentMonthSelect = document.getElementById('rent-month');
            const rentYearInput = document.getElementById('rent-year');
            rentMonthSelect.innerHTML = months.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            rentMonthSelect.value = today.getMonth();
            rentYearInput.value = today.getFullYear();
            
            // Re-bind all event listeners
            rentMonthSelect.addEventListener('change', renderAll);
            rentYearInput.addEventListener('change', renderAll);
            document.getElementById('transaction-type').addEventListener('change', updateCategoryOptions);
            document.getElementById('transaction-category').addEventListener('change', handleCategoryChange);
            document.getElementById('tenant-form').addEventListener('submit', handleAddOrUpdateTenant);
            document.getElementById('transaction-form').addEventListener('submit', handleAddTransaction);
            document.getElementById('loan-form').addEventListener('submit', handleAddLoan);
            document.getElementById('child-form').addEventListener('submit', handleAddChild);
            views.children.querySelector('#daily-allowance-giver').addEventListener('click', handleGiveAllowance);
            views.children.querySelector('#children-list').addEventListener('click', handleDeleteChild);
            views['rent-tracker'].querySelector('#rent-tracker-list').addEventListener('click', handleLogRentPayment);
            views.loans.querySelector('#loans-list').addEventListener('click', handleLoanActions);
            
            // Modal Listeners
            document.getElementById('confirm-modal-cancel-btn').addEventListener('click', () => hideConfirmModal());
            document.getElementById('confirm-modal-delete-btn').addEventListener('click', () => { if(onConfirmCallback) onConfirmCallback(); hideConfirmModal(); });
            document.getElementById('repayment-modal-cancel-btn').addEventListener('click', (e) => { e.preventDefault(); hideRepaymentModal(); });
            document.getElementById('repayment-form').addEventListener('submit', handleRepaymentSubmit);
            
            // Import/Export Listeners
            document.getElementById('export-btn').addEventListener('click', handleExport);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
            document.getElementById('import-file-input').addEventListener('change', handleImport);

            updateCategoryOptions();
        }

        function navigateTo(viewName) { Object.values(views).forEach(v => v.classList.add('hidden')); navLinks.forEach(l => l.classList.remove('active')); views[viewName].classList.remove('hidden'); document.getElementById(`nav-${viewName}`).classList.add('active'); renderAll(); }

        const formatCurrency = (amount) => `Rs ${parseFloat(amount || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

        function showConfirmModal(title, text, callback) { document.getElementById('confirm-modal-title').textContent = title; document.getElementById('confirm-modal-text').textContent = text; onConfirmCallback = callback; confirmModal.classList.remove('hidden', 'modal-leave-active'); confirmModal.classList.add('modal-enter-active'); }
        function hideConfirmModal() { onConfirmCallback = null; confirmModal.classList.remove('modal-enter-active'); confirmModal.classList.add('modal-leave-active'); setTimeout(() => confirmModal.classList.add('hidden'), 200); }
        function showRepaymentModal(loan) { 
            const form = document.getElementById('repayment-form');
            form.querySelector('#repayment-loan-id').value = loan.id;
            const remaining = (loan.amount || 0) - (loan.paidAmount || 0);
            form.querySelector('#repayment-amount').placeholder = `Max: ${remaining.toFixed(2)}`;
            document.getElementById('repayment-modal-title').textContent = `Log Payment for ${loan.personName}`;
            repaymentModal.classList.remove('hidden', 'modal-leave-active');
            repaymentModal.classList.add('modal-enter-active');
        }
        function hideRepaymentModal() { 
            document.getElementById('repayment-form').reset();
            document.getElementById('repayment-date').valueAsDate = new Date();
            repaymentModal.classList.remove('modal-enter-active');
            repaymentModal.classList.add('modal-leave-active');
            setTimeout(() => repaymentModal.classList.add('hidden'), 200);
        }

        function renderAll() {
            renderDashboard();
            renderTenants();
            renderRentTracker();
            renderChildrenList();
            renderDailyAllowanceGiver();
            renderAllowanceHistory();
            renderLoans();
            renderTransactions();
            updateTenantDropdown();
        }
        
        function renderDashboard() { const totalIncome=transactions.filter(t=>t.type==='income').reduce((sum,t)=>sum+parseFloat(t.amount||0),0);const totalExpense=transactions.filter(t=>t.type==='expense').reduce((sum,t)=>sum+parseFloat(t.amount||0),0);const netBalance=totalIncome-totalExpense;const totalReceivables=loans.filter(l=>l.type==='lent').reduce((sum,l)=>sum+((l.amount||0)-(l.paidAmount||0)),0);const totalPayables=loans.filter(l=>l.type==='borrowed').reduce((sum,l)=>sum+((l.amount||0)-(l.paidAmount||0)),0);document.getElementById('total-income').textContent=formatCurrency(totalIncome);document.getElementById('total-expense').textContent=formatCurrency(totalExpense);document.getElementById('net-balance').textContent=formatCurrency(netBalance);document.getElementById('total-receivables').textContent=formatCurrency(totalReceivables);document.getElementById('total-payables').textContent=formatCurrency(totalPayables);}
        function renderDailyAllowanceGiver(){const list=document.getElementById('daily-allowance-giver');if(!list)return;if(children.length===0){list.innerHTML=`<p class="text-center text-sm text-gray-500">Add a child to give an allowance.</p>`;return;}list.innerHTML=children.map(child=>`<div class="flex items-center space-x-2"><span class="flex-1 font-semibold text-gray-700">${child.name}</span><input type="number" class="w-24 px-2 py-1 border border-gray-300 rounded-md shadow-sm" placeholder="Rs"><button data-child-id="${child.id}" data-child-name="${child.name}" class="give-allowance-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md font-semibold">Give</button></div>`).join('');}
        function renderChildrenList(){const list=document.getElementById('children-list');if(!list)return;if(children.length===0){list.innerHTML=`<p class="text-center text-sm text-gray-500">No children added yet.</p>`;return;}list.innerHTML=children.map(child=>`<div class="flex items-center justify-between p-2 bg-gray-50 rounded-md"><span>${child.name}</span><button data-id="${child.id}" class="delete-child-btn text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button></div>`).join('');}
        function renderAllowanceHistory(){const list=views.children.querySelector('#allowance-history-list');if(!list)return;if(transactions.length===0){list.innerHTML=`<tr><td colspan="4" class="text-center py-8 text-gray-500">No allowance history.</td></tr>`;return;}const allowanceTxs=transactions.filter(t=>t.category==='Allowance'&&t.type==='expense').sort((a,b) => new Date(b.date) - new Date(a.date));if(allowanceTxs.length===0){list.innerHTML=`<tr><td colspan="4" class="text-center py-8 text-gray-500">No allowance history.</td></tr>`;return;}list.innerHTML=allowanceTxs.map(a=>`<tr class="border-b hover:bg-gray-50"><td class="py-3 px-3">${a.date}</td><td class="py-3 px-3">${a.description.replace('Daily allowance for ','')}</td><td class="py-3 px-3 text-right font-semibold">${formatCurrency(a.amount)}</td><td class="py-3 px-3 text-center"><button data-id="${a.id}" class="delete-transaction-btn text-red-500 hover:text-red-700 text-xs"><i class="fas fa-trash-alt"></i></button></td></tr>`).join('');list.querySelectorAll('.delete-transaction-btn').forEach(btn=>btn.addEventListener('click',handleDeleteTransaction));}
        function handleAddChild(e){e.preventDefault();const nameInput=document.getElementById('child-name');const name=nameInput.value.trim();if(!name)return;children.push({id:`child_${Date.now()}`,name});nameInput.value='';renderAll();}
        function handleDeleteChild(e){const button=e.target.closest('.delete-child-btn');if(!button)return;const childId=button.dataset.id;showConfirmModal('Delete Child','Are you sure?',()=>{children=children.filter(c=>c.id!==childId);renderAll();});}
        function handleGiveAllowance(e){const button=e.target.closest('.give-allowance-btn');if(!button)return;const amountInput=button.previousElementSibling;const amount=parseFloat(amountInput.value);if(!amount||amount<=0)return;const{childId,childName}=button.dataset;const date=new Date().toISOString().split('T')[0];transactions.push({id:`tx_${Date.now()}`,type:'expense',category:'Allowance',amount,date,description:`Daily allowance for ${childName}`,childId});amountInput.value='';renderAll();}
        function renderTenants(){const list=document.getElementById('tenants-list');if(!list)return;if(tenants.length===0){list.innerHTML=`<p class="text-center py-8 text-gray-500">No tenants added yet.</p>`;return;}list.innerHTML=tenants.map(t=>`<div class="border rounded-lg p-4 bg-gray-50 flex justify-between items-start"><div><p class="font-bold text-lg text-indigo-700">${t.houseName}</p><p class="text-gray-700"><i class="fas fa-user mr-2 text-gray-400"></i>${t.tenantName}</p><p class="text-gray-700"><i class="fas fa-phone mr-2 text-gray-400"></i>${t.contactNumber}</p><p class="text-gray-700 font-semibold"><i class="fas fa-money-bill-wave mr-2 text-gray-400"></i>${formatCurrency(t.monthlyRent)} / month</p></div><div class="flex space-x-3"><button data-id="${t.id}" class="edit-tenant-btn text-blue-500 hover:text-blue-700 text-lg"><i class="fas fa-edit"></i></button><button data-id="${t.id}" class="delete-tenant-btn text-red-500 hover:text-red-700 text-lg"><i class="fas fa-trash-alt"></i></button></div></div>`).join('');list.querySelectorAll('.delete-tenant-btn').forEach(btn=>btn.addEventListener('click',handleDeleteTenant));list.querySelectorAll('.edit-tenant-btn').forEach(btn=>btn.addEventListener('click',handleEditTenant));}
        function renderRentTracker(){const container=document.getElementById('rent-tracker-list');const rentMonthSelect=document.getElementById('rent-month');const rentYearInput=document.getElementById('rent-year');if(!container||!rentMonthSelect||!rentYearInput)return;const selectedMonth=parseInt(rentMonthSelect.value);const selectedYear=parseInt(rentYearInput.value);if(tenants.length===0){container.innerHTML=`<p class="text-center py-12 text-gray-500">Add tenants to track rent.</p>`;return;}const rentData=tenants.map(tenant=>{const rentPayments=transactions.filter(t=>{const transDate=new Date(t.date);return t.category==='Rent'&&t.tenantId===tenant.id&&transDate.getMonth()===selectedMonth&&transDate.getFullYear()===selectedYear;});const amountPaid=rentPayments.reduce((sum,t)=>sum+parseFloat(t.amount),0);const balance=parseFloat(tenant.monthlyRent)-amountPaid;let status,statusColor,logPaymentBtn='';if(balance>0){logPaymentBtn=`<button data-tenant-id="${tenant.id}" data-amount="${balance}" class="log-rent-payment-btn text-xs bg-green-500 text-white py-1 px-2 rounded hover:bg-green-600">Log Payment</button>`;}if(amountPaid>=parseFloat(tenant.monthlyRent)){status='Paid';statusColor='bg-green-100 text-green-800';}else if(amountPaid>0){status='Partially Paid';statusColor='bg-yellow-100 text-yellow-800';}else{status='Unpaid';statusColor='bg-red-100 text-red-800';}return{...tenant,amountPaid,balance,status,statusColor,logPaymentBtn};});container.innerHTML=`<table class="w-full text-left"><thead><tr class="border-b bg-gray-50"><th class="py-3 px-4 font-semibold">Tenant</th><th class="py-3 px-4 font-semibold text-center">Status</th><th class="py-3 px-4 font-semibold text-right">Monthly Rent</th><th class="py-3 px-4 font-semibold text-right">Amount Paid</th><th class="py-3 px-4 font-semibold text-right">Remaining Balance</th><th class="py-3 px-4 font-semibold text-center">Action</th></tr></thead><tbody>${rentData.map(d=>`<tr class="border-b hover:bg-gray-50"><td class="py-3 px-4"><p class="font-bold">${d.tenantName}</p><p class="text-sm text-gray-500">${d.houseName}</p></td><td class="py-3 px-4 text-center"><span class="px-3 py-1 text-xs font-bold rounded-full ${d.statusColor}">${d.status}</span></td><td class="py-3 px-4 text-right">${formatCurrency(d.monthlyRent)}</td><td class="py-3 px-4 text-right text-green-600 font-semibold">${formatCurrency(d.amountPaid)}</td><td class="py-3 px-4 text-right text-red-600 font-bold">${formatCurrency(d.balance)}</td><td class="py-3 px-4 text-center">${d.logPaymentBtn}</td></tr>`).join('')}</tbody></table>`;}
        function handleLogRentPayment(e){const button=e.target.closest('.log-rent-payment-btn');if(!button)return;const{tenantId,amount}=button.dataset;const selectedMonth=parseInt(document.getElementById('rent-month').value);const selectedYear=parseInt(document.getElementById('rent-year').value);const date=new Date(selectedYear,selectedMonth,15);const dateString=date.toISOString().split('T')[0];navigateTo('transactions');const form=document.getElementById('transaction-form');form.querySelector('#transaction-type').value='income';updateCategoryOptions();form.querySelector('#transaction-category').value='Rent';handleCategoryChange();form.querySelector('#transaction-tenant').value=tenantId;form.querySelector('#transaction-amount').value=amount;form.querySelector('#transaction-date').value=dateString;}
        function renderLoans() { const list = document.getElementById('loans-list'); if (!list) return; if (loans.length === 0) { list.innerHTML = `<p class="text-center py-8 text-gray-500">No loan records yet.</p>`; return; } const sortedLoans = [...loans].sort((a, b) => { const aRemaining = (a.amount || 0) - (a.paidAmount || 0); const bRemaining = (b.amount || 0) - (b.paidAmount || 0); if (aRemaining <= 0 && bRemaining > 0) return 1; if (aRemaining > 0 && bRemaining <= 0) return -1; return new Date(b.date) - new Date(a.date); }); const renderLoanItem = l => { const totalAmount = parseFloat(l.amount || 0); const paidAmount = l.repayments?.reduce((sum, p) => sum + p.amount, 0) || 0; const remaining = totalAmount - paidAmount; const isPaid = remaining <= 0; return `<div class="border rounded-lg p-4 ${isPaid ? 'bg-gray-100' : 'bg-white'}"><div class="flex justify-between items-start"><div><p class="font-bold text-lg ${l.type === 'lent' ? 'text-blue-700' : 'text-orange-700'}">${l.personName}</p><p class="text-gray-600 text-sm">${l.description}</p><p class="text-gray-500 text-xs mt-1">On: ${l.date}</p></div><div class="text-right flex flex-col items-end"><p class="font-semibold text-xl ${l.type === 'lent' ? 'text-blue-600' : 'text-orange-600'}">${formatCurrency(remaining)}</p><p class="text-xs text-gray-500">Remaining</p></div></div><div class="mt-4 border-t pt-2"><div class="flex justify-between text-xs text-gray-600"><span>Paid: ${formatCurrency(paidAmount)}</span><span>Total: ${formatCurrency(totalAmount)}</span></div><div class="mt-4 flex justify-end items-center space-x-3">${!isPaid ? `<button data-id="${l.id}" class="log-repayment-btn text-sm bg-green-500 text-white py-1 px-3 rounded-md hover:bg-green-600 font-semibold">Log Payment</button>` : `<span class="text-sm font-semibold text-green-700">Fully Paid</span>`}<button data-id="${l.id}" class="view-history-btn text-gray-500 hover:text-gray-800"><i class="fas fa-history"></i></button><button data-id="${l.id}" class="delete-loan-btn text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button></div></div><div id="history-${l.id}" class="hidden mt-4 pt-2 border-t text-sm"></div></div>`; }; const receivables = sortedLoans.filter(l => l.type === 'lent'); const payables = sortedLoans.filter(l => l.type === 'borrowed'); let html = ''; if (receivables.length > 0) { html += `<div><h4 class="text-lg font-semibold mb-2 text-blue-800">Money I Lent (Receivables)</h4><div class="space-y-3">${receivables.map(renderLoanItem).join('')}</div></div>`; } if (payables.length > 0) { html += `<div><h4 class="text-lg font-semibold mb-2 text-orange-800">Money I Borrowed (Payables)</h4><div class="space-y-3">${payables.map(renderLoanItem).join('')}</div></div>`; } list.innerHTML = html || `<p class="text-center py-8 text-gray-500">No loan records yet.</p>`; }
        function handleLoanActions(e) { const logBtn = e.target.closest('.log-repayment-btn'); const historyBtn = e.target.closest('.view-history-btn'); const deleteBtn = e.target.closest('.delete-loan-btn'); if (logBtn) { const loan = loans.find(l => l.id === logBtn.dataset.id); if (loan) showRepaymentModal(loan); } if (historyBtn) { toggleRepaymentHistory(historyBtn.dataset.id); } if (deleteBtn) { handleDeleteLoan(deleteBtn.dataset.id); } }
        function toggleRepaymentHistory(loanId) { const historyDiv = document.getElementById(`history-${loanId}`); if (historyDiv.classList.toggle('hidden')) return; const loan = loans.find(l => l.id === loanId); const repayments = loan.repayments?.sort((a,b) => new Date(b.date) - new Date(a.date)) || []; if (repayments.length === 0) { historyDiv.innerHTML = `<p class="text-gray-500">No payments have been logged yet.</p>`; return; } historyDiv.innerHTML = `<h5 class="font-bold mb-2">Payment History</h5><ul class="space-y-1">${repayments.map(r => `<li class="flex justify-between"><span>${r.date}:</span><span class="font-medium">${formatCurrency(r.amount)}</span></li>`).join('')}</ul>`; }
        function handleRepaymentSubmit(e) { e.preventDefault(); const form = e.target; const loanId = form.querySelector('#repayment-loan-id').value; const amount = parseFloat(form.querySelector('#repayment-amount').value); const date = form.querySelector('#repayment-date').value; if (!loanId || !amount || !date) return; const loan = loans.find(l => l.id === loanId); if (!loan) return; if (!loan.repayments) loan.repayments = []; loan.repayments.push({ amount, date }); const transactionType = loan.type === 'lent' ? 'income' : 'expense'; const transactionCategory = loan.type === 'lent' ? 'Loan Repayment' : 'Loan Payment'; const description = `${transactionCategory} ${loan.type === 'lent' ? 'from' : 'to'} ${loan.personName}`; transactions.push({id:`tx_${Date.now()}`, type: transactionType, category: transactionCategory, amount, date, description, loanId}); hideRepaymentModal(); renderAll();}
        function renderTransactions(){const allList=document.getElementById('all-transactions-list');const recentList=document.getElementById('recent-transactions-list');if(!allList||!recentList)return;const mapToRow=(t)=>{const isIncome=t.type==='income';const amountClass=isIncome?'text-green-600':'text-red-600';const sign=isIncome?'+':'-';return`<tr class="border-b hover:bg-gray-50"><td class="py-3 px-3">${t.date}</td><td class="py-3 px-3">${t.description}</td><td class="py-3 px-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${isIncome?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${t.category}</span></td><td class="py-3 px-3 text-right font-semibold ${amountClass}">${sign} ${formatCurrency(t.amount)}</td><td class="py-3 px-3 text-center"><button data-id="${t.id}" class="delete-transaction-btn text-red-500 hover:text-red-700 text-xs"><i class="fas fa-trash-alt"></i></button></td></tr>`;};if(transactions.length===0){const placeholder=`<tr><td colspan="5" class="text-center py-8 text-gray-500">No transactions recorded yet.</td></tr>`;allList.innerHTML=placeholder;recentList.innerHTML=placeholder;return;}const sortedTxs = [...transactions].sort((a,b) => new Date(b.date) - new Date(a.date));allList.innerHTML=sortedTxs.map(t=>mapToRow(t)).join('');recentList.innerHTML=sortedTxs.slice(0,5).map(t=>mapToRow(t)).join('');allList.querySelectorAll('.delete-transaction-btn').forEach(btn=>btn.addEventListener('click',handleDeleteTransaction));recentList.querySelectorAll('.delete-transaction-btn').forEach(btn=>btn.addEventListener('click',handleDeleteTransaction));}
        function updateCategoryOptions(){const type=document.getElementById('transaction-type').value;document.getElementById('transaction-category').innerHTML=categories[type].map(cat=>`<option value="${cat}">${cat}</option>`).join('');handleCategoryChange();}
        function handleCategoryChange(){document.getElementById('tenant-select-container').classList.toggle('hidden',document.getElementById('transaction-category').value!=='Rent');}
        function updateTenantDropdown(){const select=document.getElementById('transaction-tenant');if(!select)return;if(tenants.length===0){select.innerHTML='<option disabled selected>Add a tenant first</option>';}else{select.innerHTML=tenants.map(t=>`<option value="${t.id}">${t.tenantName} (${t.houseName})</option>`).join('');}}
        function handleAddOrUpdateTenant(e){e.preventDefault();const form=document.getElementById('tenant-form');const tenantId=form.querySelector('#tenant-id').value;const tenantData={id:tenantId||`tenant_${Date.now()}`,houseName:form.querySelector('#house-name').value.trim(),tenantName:form.querySelector('#tenant-name').value.trim(),contactNumber:form.querySelector('#tenant-contact').value.trim(),monthlyRent:parseFloat(form.querySelector('#tenant-rent').value)||0,};if(!tenantData.houseName||!tenantData.tenantName)return;if(tenantId){const index=tenants.findIndex(t=>t.id===tenantId);if(index!==-1)tenants[index]=tenantData;}else{tenants.push(tenantData);}resetTenantForm();renderAll();}
        function resetTenantForm(){const form=document.getElementById('tenant-form');form.reset();form.querySelector('#tenant-id').value='';form.querySelector('#tenant-form-btn-text').textContent='Add Tenant';}
        function handleEditTenant(e){const button=e.target.closest('.edit-tenant-btn');const tenantId=button.dataset.id;const tenant=tenants.find(t=>t.id===tenantId);if(tenant){const form=document.getElementById('tenant-form');form.querySelector('#tenant-id').value=tenant.id;form.querySelector('#house-name').value=tenant.houseName;form.querySelector('#tenant-name').value=tenant.tenantName;form.querySelector('#tenant-contact').value=tenant.contactNumber;form.querySelector('#tenant-rent').value=tenant.monthlyRent;form.querySelector('#tenant-form-btn-text').textContent='Update Tenant';}}
        function handleDeleteTenant(e){const button=e.target.closest('.delete-tenant-btn');const tenantId=button.dataset.id;showConfirmModal('Delete Tenant','Are you sure?',()=>{tenants=tenants.filter(t=>t.id!==tenantId);resetTenantForm();renderAll();});}
        function handleAddLoan(e){e.preventDefault();const form=document.getElementById('loan-form');const loanData={id:`loan_${Date.now()}`,type:form.querySelector('#loan-type').value,personName:form.querySelector('#loan-person').value.trim(),amount:parseFloat(form.querySelector('#loan-amount').value),date:form.querySelector('#loan-date').value,description:form.querySelector('#loan-description').value.trim(),repayments:[]};if(!loanData.personName||!loanData.amount||!loanData.date)return;loans.push(loanData);form.reset();form.querySelector('#loan-date').valueAsDate=new Date();renderAll();}
        function handleDeleteLoan(loanId){showConfirmModal('Delete Loan Record','Are you sure? This will delete the loan and all of its repayment history.',()=>{loans=loans.filter(l=>l.id!==loanId);transactions=transactions.filter(t=>t.loanId!==loanId);renderAll();});}
        function handleAddTransaction(e){e.preventDefault();const form=document.getElementById('transaction-form');const type=form.querySelector('#transaction-type').value;const category=form.querySelector('#transaction-category').value;const amount=form.querySelector('#transaction-amount').value;const date=form.querySelector('#transaction-date').value;let description=form.querySelector('#transaction-description').value.trim();if(!type||!category||!amount||!date)return;const transactionData={id:`tx_${Date.now()}`,type,category,date,description,amount:parseFloat(amount)};if(category==='Rent'){const tenantSelect=form.querySelector('#transaction-tenant');if(tenantSelect.value){const selectedTenant=tenants.find(t=>t.id===tenantSelect.value);if(selectedTenant){transactionData.tenantId=selectedTenant.id;if(!description){transactionData.description=`Rent from ${selectedTenant.tenantName}`;}}}}transactions.push(transactionData);form.reset();form.querySelector('#transaction-date').valueAsDate=new Date();updateCategoryOptions();renderAll();}
        function handleDeleteTransaction(e){const button=e.target.closest('.delete-transaction-btn');if(!button)return;const transactionId=button.dataset.id;showConfirmModal('Delete Transaction','Are you sure?',()=>{transactions=transactions.filter(t=>t.id!==transactionId);renderAll();});}
        
        // --- IMPORT / EXPORT ---
        function handleExport() {
            const dataToSave = { tenants, transactions, loans, children };
            const jsonString = JSON.stringify(dataToSave, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `family_manager_backup_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    tenants = data.tenants || [];
                    transactions = data.transactions || [];
                    loans = data.loans || [];
                    children = data.children || [];
                    renderAll();
                    navigateTo('dashboard');
                } catch (error) {
                    alert('Error: Could not parse the file. Please make sure it is a valid backup file.');
                    console.error("Import error:", error);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // --- Start the App ---
        document.addEventListener('DOMContentLoaded', setupPasswordProtection);
    </script>
</body>
</html>

